![](assets/fortuna.jpg)

# Fortuna lottery contracts

Этот репозиторий содержит исходный код смарт-контракта лотереи Fortuna
и объяснение его механизма.


## Ползеные ссылки
- [Контракт в mainnet:](https://tonscan.org/address/EQDw51Y-nvpAl3UPkNuhcv4MSScS32PRFFNndBGJ-FoRTUNA) `EQDw51Y-nvpAl3UPkNuhcv4MSScS32PRFFNndBGJ-FoRTUNA`
- [Fortuna.run - интерфейс для общения с контрактом](https://fortuna.run)
- [NFT Web3TON - коллекция, холдеры которой получают доход с лотереи](https://web3ton.pro)
- [NFT Web3TON на GetGems](https://getgems.io/collection/EQCdVlYKvCuUaVIWjwlGtQgWvDa8DsbCNEM6hHevSW__-07R)


## Как оно работает

Оператор запускает тираж лотереи, где указывает призовые NFT, цену билета,
время розыгрыша. Эти данные не могут быть изменены вплоть до момента
розыгрыша никем. Покупка билета происходит по обычному переводу на адрес
контракта суммы кратной цене билета. Например: цена билета 2 TON; чтобы
купить один билет, нужно отправить 2 TON, два - 4 TON, три - 6 TON и так
далее. Билет это контракт с интерфейсом (get-методами) NFT. Трансфер
билета может осуществлять только контракт лотереи (NFT коллекции). При
покупке билета, лотерея или минтит новый NFT-билет, или делает участника
владельцем одного из существующих, следующего по счету, билета. Лотерея
отправляет 50% призового фонда на 2 сервисных кошелька (один для рассылки
дохода холдерам NFT Web3TON, другой - для закупки NFT на следующий
розыгрыш), остальные 50% от отправленной участником суммы контракт
добавляет в призовой фонд лотереи.

![](assets/fortuna_buy.png)

Когда время переходит установленный порог розыгрыша, при любом вызове
контракта будет произведен розыгрыш. Тогда лотерея выбирает случайные
числа - индексы выигравших билетов по количеству призов и отправляет на
них запросы адресов их владельцев. Вызвавшему контракт адресу возвращаются
монеты за вычитом комиссий.

> Если билетов для розыгрыша не хватает, время розыгрыша увеличивается на
> 2ч и покупка билетов продолжается.

Когда приходит ответ на запрос владельца от NFT-билета, лотерея отправляет
приз: монеты из призового пула или трансфер призовой NFT к победителю. 

![](assets/fortuna_draw_scheme.png)

После розыгрыша NFT-билеты по get-методу возвращают своим владельцем адрес
лотереи. То есть в идеальном мире билеты должны были бы исчезнуть из
кошельков пользователей в момент розыгрыша, но так как индексация
в кошельках происходит постепенно, билеты исчезают не так быстро, как
хотелось бы. Сразу пропадают только выигрышные билеты, потому что они
обработали транзакцию и информация о них была обновлена.


## License

MIT
